services:
  # --- Infrastructure ---
  eureka-server:
    build:
      context: .
      dockerfile: services/eureka-server/Dockerfile
    ports:
      - "8761:8761"
    environment:
      - JAVA_OPTS=-Xms256m -Xmx400m
      - EUREKA_INSTANCE_HOSTNAME=eureka-server
      - EUREKA_CLIENT_REGISTER_WITH_EUREKA=false
      - EUREKA_CLIENT_FETCH_REGISTRY=false
    deploy:
      resources:
        limits:
          memory: 512M
    # healthcheck:
    #   # This uses a bash-specific way to check the port if curl is missing
    #   test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8761 && echo -e 'GET / HTTP/1.1\r\nHost: localhost\r\n\r\n' >&3 && grep '200 OK' <&3"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 5
    networks:
      - food-delivery-net

  # --- Databases ---
  # Databases are less memory-heavy for dev, but we'll cap them to be safe
  restaurant-db:
    image: mysql:9.1
    environment:
      MYSQL_DATABASE: restaurant_db
      MYSQL_ROOT_PASSWORD: root
    deploy:
      resources:
        limits:
          memory: 512M
    ports:
      - "3306:3306"
    volumes:
      - ./services/restaurant-service/db-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - food-delivery-net

  catalog-db:
    image: mysql:9.1
    environment:
      MYSQL_DATABASE: food_catalog_db
      MYSQL_ROOT_PASSWORD: root
    deploy:
      resources:
        limits:
          memory: 512M
    ports:
      - "3307:3306"
    volumes:
      - ./services/food-catalog-service/db-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - food-delivery-net

  user-db:
    image: mysql:9.1
    environment:
      MYSQL_DATABASE: user_db
      MYSQL_ROOT_PASSWORD: root
    deploy:
      resources:
        limits:
          memory: 512M
    ports:
      - "3308:3306"
    volumes:
      - ./services/user-service/db-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - food-delivery-net

  order-db:
    image: mongo:7.0
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=password
      - MONGO_INITDB_DATABASE=order_db
    deploy:
      resources:
        limits:
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.runCommand({ping:1})' --username admin --password password --authenticationDatabase admin"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - food-delivery-net

  # --- Microservices ---
  restaurant-service:
    build:
      context: .
      dockerfile: services/restaurant-service/Dockerfile
    ports:
      - "9091:9091"
    environment:
      - EUREKA_SERVER=eureka-server
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:mysql://restaurant-db:3306/restaurant_db
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - JAVA_OPTS=-Xms256m -Xmx400m
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      # eureka-server:
      #   condition: service_healthy
      restaurant-db:
        condition: service_healthy
    networks:
      - food-delivery-net

  food-catalog-service:
    build:
      context: .
      dockerfile: services/food-catalog-service/Dockerfile
    ports:
      - "9092:9092"
    environment:
      - EUREKA_SERVER=eureka-server
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:mysql://catalog-db:3306/food_catalog_db
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - JAVA_OPTS=-Xms256m -Xmx400m
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      # eureka-server:
      #   condition: service_healthy
      catalog-db:
        condition: service_healthy
    networks:
      - food-delivery-net

  user-service:
    build:
      context: .
      dockerfile: services/user-service/Dockerfile
    ports:
      - "9093:9093"
    environment:
      - EUREKA_SERVER=eureka-server
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:mysql://user-db:3306/user_db
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - JAVA_OPTS=-Xms256m -Xmx400m
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      # eureka-server:
      #   condition: service_healthy
      user-db:
        condition: service_healthy
    networks:
      - food-delivery-net

  order-service:
    build:
      context: .
      dockerfile: services/order-service/Dockerfile
    ports:
      - "9094:9094"
    environment:
      - EUREKA_SERVER=eureka-server
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - MONGODB_HOST=order-db
      - MONGODB_PORT=27017
      - MONGODB_USER=admin
      - MONGODB_PASSWORD=password
      - JAVA_OPTS=-Xms256m -Xmx400m
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      # eureka-server:
      #   condition: service_healthy
      order-db:
        condition: service_healthy
    networks:
      - food-delivery-net

  # --- Frontend ---
  frontend:
    build:
      context: ./frontend/food-delivery-app
      dockerfile: Dockerfile
    ports:
      - "4200:80"
    deploy:
      resources:
        limits:
          memory: 256M # Nginx is very light
    networks:
      - food-delivery-net

networks:
  food-delivery-net:
    driver: bridge